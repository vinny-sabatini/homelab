---
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: talos-cp01
  namespace: testing-kubevirt
  labels:
    app: talos
spec:
  runStrategy: Always
  template:
    spec:
      terminationGracePeriodSeconds: 0
      domain:
        clock:
          timer: {}
          utc: {}
        cpu:
          model: host-passthrough
          threads: 2
        # machine:
        #   type: q35
        resources:
          requests:
            devices.kubevirt.io/kvm: "1"
            memory: 2G
        devices:
          rng: {}
          autoattachSerialConsole: true
          autoattachGraphicsDevice: true
          autoattachPodInterface: false
          disks:
          - name: talos-cp01-disk-vda-root
            bootOrder: 2
            disk:
              bus: virtio
          - name: talos-cp01-disk-vdb-data
            bootOrder: 1
            disk:
              bus: virtio
          interfaces:
          - name: bridge
            bridge: {}
            ports:
              - name: talos
                port: 50000
              - name: kubeapi
                port: 6443
      networks:
      - name: bridge
        multus:
          networkName: bridge-conf
      volumes:
      - name: talos-cp01-disk-vda-root
        dataVolume:
          name: talos-cp01-volume-vda-root
      - name: talos-cp01-disk-vdb-data
        dataVolume:
          name: talos-cp01-volume-vdb-data
  dataVolumeTemplates:
  - metadata:
      name: talos-cp01-volume-vda-root
    spec:
      pvc:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 10G
      source:
        http:
          url: https://github.com/siderolabs/talos/releases/download/v1.10.1/metal-amd64.iso
  - metadata:
      name: talos-cp01-volume-vdb-data
    spec:
      pvc:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 10G
      source:
        blank: {}
